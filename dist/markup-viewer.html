<!DOCTYPE html>

<script src="../../webcomponentsjs/webcomponents-lite.min.js"></script>
<script src="../../commonmark/dist/commonmark.min.js"></script>

<template id="template">
<div id="viewer">Loading...</div>
<script>

/**
 * Main script.
 */
window.onload = function() {
    var markup = getParameterByName("markup", window.location.search);
    if (markup) {
        updateMarkup(markup);
    } else {
        document.getElementById("viewer").innerHTML
            = "Please specify 'markup' query like below.<br><code>"
            + window.location.origin + window.location.pathname
            + "?markup=&lturi-of-a-markup-file&gt</code>";
    }
}

/**
 * Get a value of the first query matching argument 'name'.
 * @param  {string}  name Name of the query
 * @param  {string}  uri  URI to search the query from
 * @return {?string}      Parameter of the query, or null
 */
function getParameterByName(name, uri) {
    var match = RegExp('[?&]' + name + '=([^&]*)').exec(uri);
    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
}

/**
 * Get contents of a markup file
 * @param {string} uri URI of the markup file
 */
function updateMarkup(uri) {
    const EXTENSIONS_MD = ["md", "mdown", "markdown"];
    requestHTTP("GET", uri, function(responseText) {
        var extension = (uri.match(/\.([a-zA-Z0-9]*)([\?#].*)?$/) || [,""])[1];
        var match_md = EXTENSIONS_MD.some(function(e) {
            return (extension.localeCompare(e) === 0);
        });
        var html = (match_md) ? parseCommonmark(responseText) : responseText;
        document.getElementById("viewer").innerHTML = html;
        replaceLink(EXTENSIONS_MD);
        jumpToHashtag();
    });
}


/**
 * Send HTTP request
 * @param {string}   method   HTTP request method (e.g. "GET", "POST")
 * @param {string}   uri      URI to send the HTTP request
 * @param {function} callback Pure function to register as a callback
 *                            (xhr.responseText is passed as the first argument)
 * @param {}                  second and below arguments of the callback
 */
function requestHTTP(method, uri, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open(method, uri);
    var arguments_of_callback = [];
    for (var i = 2; i < arguments.length; i++) {
        arguments_of_callback[i - 1] = arguments[i];
    }
    xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            arguments_of_callback[0] = xhr.responseText;
            callback.apply(this, arguments_of_callback);
        }
    };
    xhr.send();
}

/**
 * Parse a markup written in Commonmark.
 * <https://github.com/jgm/commonmark.js>
 * @param {string} text Text written in commonmark
 */
function parseCommonmark(text) {
    var reader = new commonmark.Parser();
    var parsed = reader.parse(text);
    var writer = new commonmark.HtmlRenderer();
    return writer.render(parsed);
}

/**
 * Parse a markup written in Asciidoc.
 * <https://github.com/asciidoctor/asciidoctor.js>
 * @param {string} text Text written in Asciidoc
 */
function parseAsciidoc(text) {
    var options = Opal.hash({attributes: ['showtitle']});
    return Opal.Asciidoctor.$convert(text, options);
}

/**
 * Replace all HTML links to markup files for AJAX requests
 * @param {string[]} extensions Extensions of target markup files
 */
function replaceLink(extensions) {
    var links = document.getElementById("viewer").getElementsByTagName("a");
    Array.prototype.forEach.call(links, function(l) {
        extensions.forEach(function(extension) {
            if (RegExp("\." + extension + "$").exec(l.pathname)) {
                l.onclick = function() {
                    var href = (RegExp(l.origin).exec(l.href))
                        ? l.pathname + l.hash: l.href;
                    updateMarkup(href);
                    history.pushState(null, document.title, "?markup=" + href);
                    return false;
                };
            }
        });
    });
}

/**
 * Just jump to hashtag of current address bar
 */
function jumpToHashtag() {
    var hashtag = window.location.hash;
    window.location.hash = "";
    window.location.hash = hashtag;
}

</script>
</template>

<script>
var thisDocument = document.currentScript.ownerDocument;
var thisElement = Object.create(HTMLElement.prototype);
thisElement.createdCallback = function() {
    var template = thisDocument.getElementById("template");
    var clone = document.importNode(template.content, true);
    this.appendChild(clone);
}
document.registerElement('markup-viewer', {
    prototype: thisElement,
});
</script>
